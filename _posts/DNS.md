## DNS服务器

域名服务器是指管理域名的主机和相应的软件，它可以管理所在分层的域的相关信息。一个域名服务器所负责管里的分层叫作 **区 (ZONE)**。域名的每层都设有一个域名服务器：

- 根域名服务器
- 顶级域名服务器
- 权限域名服务器

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7494287fe36d4415bf75662fba1bca86~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" alt="image-20220614153906410" style="zoom:50%;" />

除了上面三种 DNS 服务器，还有一种不在 DNS 层次结构之中，但是很重要的 DNS 服务器，即**本地域名服务器**。

1. 根域名服务器

​			上面我们提到，ICANN 维护着一张根域名列表，里面记载着顶级域名和对应的托管商，其实根域名列表的正式名称是 **DNS 根区**（DNS root zone），保存 DNS 根区文件的服务器，就叫做 **DNS 根域名服务器**（root name server）。根域名服务器**保存所有的顶级域名服务器的地址**.前面我们说过，理论上**所有域名的查询都必须先查询根域名**，所以一般来说所有的域名服务器都会注册一份根域名服务器的 IP 地址的缓存，用于在必要的时候向其发送请求。

2. 顶级域名服务器

​			按照根域名服务器管理顶级域名的逻辑，顶级域名服务器显然就是用来**管理注册在该顶级域名下的所有二级域名**的，**记录这些二级域名的 IP 地址**。

3. 权限域名服务器

​			按照上面的逻辑，权限域名服务器应该是管理注册在二级域名下的所有三/四级域名的，但其实不是这样，如果一个二级域名或者一个三/四级域名对应一个域名服务器，则域名服务器数量会很多，我们需要使用**划分区**的办法来解决这个问题。那么权限域名服务器就是负责管理一个“**区**”的域名服务器。

❓ 什么是区？怎样划分区呢？

区和域其实是不同的，区可以有多种不同的划分方法。以百度为例，我们假设有 `fanyi.baidu.com`、`ai.baidu.com`、`tieba.baidu.com` 这三个三级域名。我们可以这样分区，`fanyi.baidu.com` 和 `tieba.baidu.com` 放在 `baidu.com` 权限域名服务器，`ai.baidu.com` 放在 `ai.baidu.com` 权限域名服务器中。并且 `baidu.com` 权限域名服务器和 `ai.baidu.com` 权限域名服务器是**同等地位**的，而具体怎么分区是百度公司根据域名多少、访问多少等情况去自己规定的。

4. 本地域名服务器

​			除了上面三种 DNS 服务器，还有一种不在 DNS 层次结构之中，但是很重要的 DNS 服务器，就是**本地域名服务器**（也被称为**权威域名服务器**）。本地域名服务器是电脑解析时的**默认**域名服务器，即电脑中设置的首选 DNS 服务器和备选 DNS 服务器。常见的有电信、联通、谷歌、阿里等的本地 DNS 服务。

​			每个因特网服务提供者或一所大学，甚至一所大学中的各个系，都可以拥有一个本地域名服务器。**当一台主机发出 DNS 查询请求时，这个查询请求报文就发送给该主机的本地域名服务器**。**本地域名服务器管理本地域名的解析和映射，并且能够向上级域名服务器进行查询**。

## DNS查询方式

具体 DNS 查询的方式有两种：

- 递归查询
- 迭代查询

所谓递归就是，如果请求的接收者不知道所请求的内容，那么**接收者将扮演请求者**，发出有关请求，直到获得所需要的内容，然后将内容返回给最初的请求者。

👍 通俗点来说，在递归查询中，如果 A 请求 B，那么 B 作为请求的接收者一定要给 A 想要的答案；而迭代查询则是指，如果接收者 B 没有请求者 A 所需要的准确内容，接收者 B 将告诉请求者 A，如何去获得这个内容，但是自己并不去发出请求。

一般来说，**域名服务器之间的查询使用迭代查询方式，以免根域名服务器的压力过大**。通过下面这两个图就能很好的理解了 👇

递归查询

<img src = "https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f06daba321b4069a8979167300e6878~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" style="zoom:50%;" >

迭代查询

<img src = "https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39a795c048c3495ca2dd7c2aaa49fd47~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" style="zoom:50%;" >

## 域名缓存

上面讲解的是域名服务器之间的 DNS 查询请求过程，但实际上，每个时刻都有无数网民要上网，那每次都去访问本地域名服务器去获取 IP 地址显然是不实际的。解决方法就是**使用缓存保存域名和 IP 地址的映射**。

计算机中 DNS 记录在本地有两种缓存方式：浏览器缓存和操作系统缓存。

1）**浏览器缓存**：浏览器在获取网站域名的实际 IP 地址后会对其进行缓存，减少网络请求的损耗。每种浏览器都有一个固定的 DNS 缓存时间，如 Chrome 的过期时间是 1 分钟，在这个期限内不会重新请求 DNS

2）**操作系统缓存**：操作系统的缓存其实是用户自己配置的 hosts 文件。比如 Windows10 下的 hosts 文件存放在 C:\Windows\System32\drivers\etc\hosts

OK，将我们上面所说的域名服务器之间的 DNS 查询请求过程和域名缓存结合起来，就是一个完整的 DNS 协议进行域名解析的过程。这里我们以正向解析为例（域名解析成 IP 地址）：

1）首先搜索**浏览器的 DNS 缓存**，缓存中维护一张域名与 IP 地址的对应表；

2）若没有命中，则继续搜索**操作系统的 DNS 缓存**；

3）若仍然没有命中，则操作系统将域名发送至**本地域名服务器**，本地域名服务器查询自己的 DNS 缓存，查找成功则返回结果（注意：主机和本地域名服务器之间的查询方式是**递归查询**）；

4）若本地域名服务器的 DNS 缓存没有命中，则本地域名服务器向上级域名服务器进行查询，通过以下方式进行**迭代查询**（注意：本地域名服务器和其他域名服务器之间的查询方式是迭代查询，防止根域名服务器压力过大）：

- 首先本地域名服务器向**根域名服务器**发起请求，根域名服务器是最高层次的，它并不会直接指明这个域名对应的 IP 地址，而是返回顶级域名服务器的地址，也就是说给本地域名服务器指明一条道路，让他去这里寻找答案
- 本地域名服务器拿到这个**顶级域名服务器**的地址后，就向其发起请求，获取**权限域名服务器**的地址
- 本地域名服务器根据权限域名服务器的地址向其发起请求，最终得到该域名对应的 IP 地址

4）本地域名服务器将得到的 IP 地址返回给操作系统，同时自己将 IP 地址缓存起来

5）操作系统将 IP 地址返回给浏览器，同时自己也将 IP 地址缓存起来

6）至此，浏览器就得到了域名对应的 IP 地址，并将 IP 地址缓存起来

<img src = "https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/668392324cbe4c12b66d77ddbfcd25cc~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" style="zoom:50%;" >



## DNS为什么使用UDP作为传输层协议

**「DNS 使用 UDP 协议作为传输层协议的主要原因是为了避免使用 TCP 协议时造成的连接时延。」**

- 为了得到一个域名的 IP 地址，往往会向多个域名服务器查询，如果使用 TCP 协议，那么每次请求都会存在连接时延，这样使 DNS 服务变得很慢。
- 大多数的地址查询请求，都是浏览器请求页面时发出的，这样会造成网页的等待时间过长。

